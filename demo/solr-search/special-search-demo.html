<html no-ng-app="ssDemo">
  <head>
    <title>Demo Special Search Page</title>

    <link rel='stylesheet' href='/bower_components/bootstrap/dist/css/bootstrap.min.css'/>
    <link rel='stylesheet' href='/bower_components/font-awesome/css/font-awesome.css'/>

    <link rel='stylesheet' href='/bower_components/jquery-ui/themes/base/jquery-ui.css'/>
    <link rel='stylesheet' href='/bower_components/jquery-ui-bootstrap/jquery.ui.theme.css'/>

    <script src='/bower_components/jquery/dist/jquery.min.js'></script>
    <script src='/bower_components/jquery-ui/jquery-ui.min.js'></script>
    <script src='/bower_components/bootstrap/dist/js/bootstrap.min.js'></script>
    <script src='/bower_components/angular/angular.min.js'></script>

    <script src='/src/search/searchStrap.js'></script>

<script src="https://d3js.org/d3.v3.min.js"></script>
    <script src='https://cdn.rawgit.com/leocornus/leocornus-visualdata/v0.0.6/src/zoomable-circles.js'></script>
    <script>
// this will replace the code in controller.js
//var simpleTest = angular.module('ssDemo', []);

jQuery(document).ready(function($) {

    $('#search-input').searchStrap({
        //searchUrl: 'http://gsddtovsdvap014.cihs.gov.on.ca/wp-admin/admin-ajax.php?callback=?&action=opspedia_advanced_search',
        searchUrl: 'http://intra.net.gov.on.ca/wp-admin/admin-ajax.php?callback=?&action=opspedia_advanced_search',
        //searchUrl: '/advancedsearch',
        itemsPerPage: 12,
        // we don't need search button here.
        fq: 'site: wiki AND keywords: Acronyms',
        //fq: 'keywords: "User Profile"',
        //searchButton: 'sizing-addon',
        facet: {
            facetField: ['authors']
        },
        resultSelector: '#result-list',
        resultTemplate: buildAcronymsCircles,
        panelFunction: acronymPanelStripper,
        autoReload: false
    });
});

var simpleColumnBuilder = function(item) {

    var panel = '<div class="col-sm-3">' + 
        '<h2><a href="' + item['url'] + '">' +
        item['title'] + '</a></h2>' +
        '<p>' + item['description'] + '</p>' + 
        '</div>';
    return panel;
};

/**
 * build the Acronyms list, which will have 6 columns
 */
var buildAcronymsList = function(docs, currentQuery, total, 
                            currentPage, totalPages, pagination) {

    var resultSummary = '';
    if(total > 0) {
        var end = currentQuery.start +
                  currentQuery.perPage - 1;
        end = end > total ? total : end;
        resultSummary =
            'Page <strong>' + currentPage + '</strong>' +
            ' Showing [<strong>' + currentQuery.start +
            '</strong> - <strong>' + end +
            '</strong>] of <strong>' +
            total + '</strong> total results';
    } else {
        // no result found
        resultSummary =
            '<strong>No results containing ' +
            'all your search terms were found.</strong>';
    }
    $('#search-info').html(resultSummary);

    // build a 6 columns to show 
    var result = $("#result-list");
    result.html("");

    //result.append('<div>' + pagination + '</div>');
    var colQueue =[];
    for(i = 0; i < docs.length; i++) {
        var acronym = docs[i];
        var panel = acronymPanelStripper(acronym);
        colQueue.push(panel);
        // i count from 0
        // 6 acronyms for a row
        var ready2Row = (i + 1) % 4;
        if(ready2Row == 0) {
            result.append('<div class="row">' +
                colQueue.join("") + '</div>');
            // reset the queue.
            colQueue = [];
        }
    }

    // check if we missed anything...
    if(colQueue.length > 0) {

        // append to the last row.
        result.append('<div class="row">' +
            colQueue.join(" ") +
            '</div>');
    }

    // add the pagination at the bottom too.
    result.append('<div>' + pagination + '</div>');

    return result;
};

/**
 * builder function to strip out all wiki syntax.
 */
var acronymPanelStripper = function(acronym) {

    // try to remove some wiki markups.
    var desc = acronym['description'];
    // replace wiki syntax.
    var text = desc
       .replace(/.*may refer to:/g, '')
       .replace(/\[http.*/g, '')
       .replace(/\[\[Category:.*/g, '')
       .replace(/[\]\[\']/g, '')
       .replace(/\*/, '<li class="list-group-item">')
       .replace(/\*/g, '</li><li class="list-group-item">');

    var panel = '<div class="col-sm-3">' + 
        '<h2 class="text-center">' +
        '<a href="' + acronym['url'] + '">' +
        acronym['title'] + '</a></h2>' +
        '<p><ul class="list-group">' + text + '</li></ul></p>' + 
        '</div>';
    return panel;
};

/**
 * build the Acronyms in zoomable circles. 
 */
var buildAcronymsCircles = function(docs, currentQuery, total, 
                            currentPage, totalPages, pagination) {

    var resultSummary = '';
    if(total > 0) {
        var end = currentQuery.start +
                  currentQuery.perPage - 1;
        end = end > total ? total : end;
        resultSummary =
            'Page <strong>' + currentPage + '</strong>' +
            ' Showing [<strong>' + currentQuery.start +
            '</strong> - <strong>' + end +
            '</strong>] of <strong>' +
            total + '</strong> total results';
    } else {
        // no result found
        resultSummary =
            '<strong>No results containing ' +
            'all your search terms were found.</strong>';
    }
    $('#search-info').html(resultSummary);

    var result = $("#result-list");
    result.html("");
    result.append('<div id="circles"></div>');

    // get ready the data.
    var circles =[];
    for(i = 0; i < docs.length; i++) {
        var acronym = docs[i];
        var circle = '{' +
          '"name":"title",' +
          '"children":[{' +
          '  "name":"title",' +
          '  "children":[{' +
          '    "name":"' + acronym['title'] + '",' +
          '    "size":' + 1000 * (i + 1) + ',' +
          '    "imgUrl": "https://upload.wikimedia.org/wikipedia/commons/7/7d/Cartoonmmm.jpg"' +
          '  }]'+
          '}]'+
          '}';
        circles.push(circle);
    }
    // get ready the json data for the zoomable circle.
    var jsonData = '{' +
          '"attributes": {' +
          '  "title": "3 Equal size circles",' +
          '  "description": "Data example to show the data structure",' +
          '  "colorRange": [' +
          '    "green",' +
          '    "green"' +
          '  ],' +
          '  "leafFill": "lightgrey"' +
          '},' +
          '"data": {' +
          '  "name":"This will NOT show anywhere!",' +
          //'  "children":[{' +
          //'    "name":"How many found",' +
          '    "children":[' + circles.join(',') + ']' +
          //'  }]' +
          '}' +
        '}';
    var theData = JSON.parse(jsonData);
    $('#jsonstring').html(JSON.stringify(theData, null, 2));
    $('#circles').zoomableCircles({}, theData);
    console.log(theData);

    // add the pagination at the bottom too.
    result.append('<div>' + pagination + '</div>');

    return result;
};
    </script>
  </head>

  <body>
    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>
          <img src="https://www.ontario.ca/img/favicon.png" alt="..." class="img-rounded">
          OPS Acronyms
        </h1>
        <p>The following is a partial list of acronyms used throughout the <a href="http://intra.net.gov.on.ca/wiki/Ontario_Public_Service">Ontario Public Service</a>. This list is incomplete, and you can help!
        </p>

      </div>
    </div>

    <div class="container">
      <!-- Search bar -->
      <div class="container container-fluid bg-muted">
      <div class="row" id="search-bar">
        <div class="col-md-2">
        </div>

        <div class="col-md-8">
          <div class="input-group input-group-lg"
               role="group" aria-label="...">
            <span class="input-group-addon">
              <i class="fa fa-search text-primary"></i>
            </span>
            <input type="text" class="form-control"
                   placeholder="Find Acronyms"
                   id="search-input"
                   aria-describedby="sizing-addon"/>
          </div>
          <div class="text-muted text-center h4" id="search-info">
            <h2>Loading...</h2>
          </div>
        </div>

        <div class="col-md-2">
        </div>
      </div>
      </div>

      <!-- Example row of columns -->
      <div class="container container-fluid" id="result-list">
      </div>

      <div class="container container-fluid">
      <hr>
      <footer>
        <p>&copy; 2016 Company, Inc.</p>
      </footer>
      <div>
        <textarea width="100%" id="jsonstring"></textarea>
      </div>
      </div>
    </div> <!-- /container -->
  </body>
</html>
